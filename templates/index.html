<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chapter Tracker</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/styles.css') }}"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.34/moment-timezone-with-data.min.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <script>
      var update_in_progress = {{ update_in_progress|tojson }};
    </script>
    <script src="{{ url_for('static', filename='js/scripts.js') }}"></script>
    <!-- Favicons -->
    <link
      rel="icon"
      href="{{ url_for('static', filename='favicon.ico') }}"
      type="image/x-icon"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="192x192"
      href="{{ url_for('static', filename='android-icon-192x192.png') }}"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="{{ url_for('static', filename='favicon-32x32.png') }}"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="96x96"
      href="{{ url_for('static', filename='favicon-96x96.png') }}"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="{{ url_for('static', filename='favicon-16x16.png') }}"
    />
    <link
      rel="manifest"
      href="{{ url_for('static', filename='manifest.json') }}"
    />
    <meta name="msapplication-TileColor" content="#ffffff" />
    <meta
      name="msapplication-TileImage"
      content="{{ url_for('static', filename='ms-icon-144x144.png') }}"
    />
    <meta name="theme-color" content="#ffffff" />
  </head>
  <body>
    <div class="container">
      <h1>New Chapter Tracker</h1>

      <div class="table-header">
        <h2 class="toggle" onclick="toggleSection(this)">
          New Chapters <span class="badge">{{ differences|length }}</span>
        </h2>
        <div class="full-update-tooltip">
          <button onclick="forceUpdate()">
            <i class="fas fa-sync-alt"></i> Force Full Update
          </button>
          <span class="tooltiptext" id="lastUpdateTooltip">
            {{ last_full_update }}
          </span>
        </div>
      </div>

      <div class="collapsible-content">
        {% if differences %}
        <div class="table-wrapper">
          <table border="1">
            <thead>
              <th>Name</th>
              <th>Last Saved Chapter</th>
              <th>Last Found Chapter</th>
              <th>Last Updated</th>
              <th></th>
            </thead>
            {% for url, data in differences.items() %}
            <tr>
              <td>
                <div class="table-tooltip">
                  <a href="{{ url }}" target="_blank" class="domain-tooltip">
                    {{ data.name }}
                  </a>
                  <span class="tooltiptext"></span>
                </div>
              </td>
              <td>{{ data.last_saved }}</td>
              <td>{{ data.last_found }}</td>
              <td style="white-space: nowrap; width: 0">
                {{ data.timestamp }}
              </td>
              <td style="white-space: nowrap; width: 0">
                <div class="table-tooltip">
                  <button onclick="updateChapter('{{ url }}')">
                    <i class="fas fa-save"></i>
                  </button>
                  <span class="tooltiptext">Save</span>
                </div>
                <div
                  class="menu-container"
                  data-url="{{ url }}"
                  data-name="{{ data.name }}"
                >
                  <button
                    class="menu-toggle"
                    aria-haspopup="true"
                    aria-expanded="false"
                  >
                    <i class="fas fa-ellipsis-h"></i>
                  </button>

                  <div class="menu-actions" aria-hidden="true">
                    <div class="table-tooltip">
                      <button class="edit">
                        <i class="fas fa-edit"></i>
                      </button>
                      <span class="tooltiptext">Edit</span>
                    </div>
                    <div class="table-tooltip">
                      <button class="recheck">
                        <i class="fas fa-sync-alt"></i>
                      </button>
                      <span class="tooltiptext">Recheck</span>
                    </div>
                    <div class="table-tooltip">
                      <button class="danger">
                        <i class="fas fa-trash"></i>
                      </button>
                      <span class="tooltiptext">Delete</span>
                    </div>
                  </div>
                </div>
              </td>
            </tr>
            {% endfor %}
          </table>
        </div>
        {% else %}
        <div class="status-box status-success">
          <i class="fas fa-check-circle"></i>
          <span>All chapters are up to date!</span>
        </div>
        {% endif %}
      </div>

      <div class="table-header">
        <h2 class="toggle collapsed" onclick="toggleSection(this)">
          No New Chapters <span class="badge">{{ same_data|length }}</span>
        </h2>
      </div>

      <div class="collapsible-content collapsed">
        {% if same_data %}
        <div class="table-wrapper">
          <table border="1">
            <thead>
              <th>Name</th>
              <th>Last Chapter</th>
              <th>Last Updated</th>
              <th></th>
            </thead>
            {% for url, data in same_data.items() %}
            <tr>
              <td>
                <div class="table-tooltip">
                  <a href="{{ url }}" target="_blank" class="domain-tooltip">
                    {{ data.name }}
                  </a>
                  <span class="tooltiptext"></span>
                </div>
              </td>
              <td>{{ data.last_found }}</td>
              <td
                style="white-space: nowrap; width: 0"
                TODO="tooltip to show exact date, otherwise, moment(data.timestamp).fromNow() ...or just relative for today/yesterday"
              >
                {{ data.timestamp }}
              </td>
              <td style="white-space: nowrap; width: 0">
                <div
                  class="menu-container"
                  data-url="{{ url }}"
                  data-name="{{ data.name }}"
                >
                  <button
                    class="menu-toggle"
                    aria-haspopup="true"
                    aria-expanded="false"
                  >
                    <i class="fas fa-ellipsis-h"></i>
                  </button>

                  <div class="menu-actions" aria-hidden="true">
                    <div class="table-tooltip">
                      <button class="edit">
                        <i class="fas fa-edit"></i>
                      </button>
                      <span class="tooltiptext">Edit</span>
                    </div>
                    <div class="table-tooltip">
                      <button class="recheck">
                        <i class="fas fa-sync-alt"></i>
                      </button>
                      <span class="tooltiptext">Recheck</span>
                    </div>
                    <div class="table-tooltip">
                      <button class="danger">
                        <i class="fas fa-trash"></i>
                      </button>
                      <span class="tooltiptext">Delete</span>
                    </div>
                  </div>
                </div>
              </td>
            </tr>
            {% endfor %}
          </table>
        </div>
        {% else %}
        <div class="status-box status-info">
          <i class="fas fa-info-circle"></i>
          <span>No entries being tracked yet.</span>
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Floating Add Button & Add Modal -->
    <button id="floatingAddBtn" class="floating-add" aria-label="Add link">
      <i class="fas fa-plus"></i>
    </button>

    <div
      id="addModal"
      class="modal hidden"
      role="dialog"
      aria-modal="true"
      aria-labelledby="addModalTitle"
    >
      <div class="modal-backdrop" id="addModalBackdrop" tabindex="-1"></div>
      <div class="modal-box" role="document">
        <h2 id="addModalTitle">Add New Link</h2>
        <div class="modal-body">
          <input id="modalName" type="text" placeholder="Name" />
          <input id="modalUrl" type="text" placeholder="URL" />
        </div>
        <div class="modal-actions">
          <button id="modalAddBtn"><i class="fas fa-plus"></i> Add</button>
          <button id="modalCancelBtn" class="danger">Cancel</button>
        </div>
      </div>
    </div>

    <!-- TODO: make progress indicator separate for the categories !-->
    <div id="overlay" class="hidden" role="alert" aria-live="assertive">
      <div id="overlay-content">
        <div id="spinner"></div>
        <div id="statusMessage">Loading...</div>
        <div id="progressBar">
          <div id="progressFill"></div>
        </div>
      </div>
    </div>

    <script>
      var retainValue = function (value) {
        if (value > 9) {
          return Math.floor(value);
        } else {
          return Math.floor(value * 10) / 10;
        }
      };

      document.addEventListener("DOMContentLoaded", function () {
        var lastUpdate = "{{ last_full_update }}";
        if (lastUpdate) {
          moment.relativeTimeRounding(Math.floor);
          //moment.relativeTimeRounding(retainValue);
          moment.relativeTimeThreshold("s", 60);
          moment.relativeTimeThreshold("m", 60);
          moment.relativeTimeThreshold("h", 24);
          moment.relativeTimeThreshold("d", 31);
          moment.relativeTimeThreshold("M", 12);
          var relativeTime = moment(lastUpdate).fromNow();
          if (relativeTime === "Invalid date") {
            relativeTime = "Never";
          }
          document.getElementById("lastUpdateTooltip").textContent =
            relativeTime;
        }
        document.querySelectorAll(".domain-tooltip").forEach((link) => {
          try {
            const urlObj = new URL(link.href);
            let hostname = urlObj.hostname;

            // Strip "www." if present
            if (hostname.startsWith("www.")) {
              hostname = hostname.slice(4);
            }

            link.parentElement.querySelector(".tooltiptext").textContent =
              hostname;
          } catch (e) {
            link.parentElement.querySelector(".tooltiptext").textContent =
              "Invalid URL";
          }
        });
      });
    </script>
  </body>
</html>
