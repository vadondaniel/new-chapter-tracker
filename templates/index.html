<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chapter Tracker</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/styles.css') }}"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.34/moment-timezone-with-data.min.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" />
    <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <script>
      var update_in_progress = {{ update_in_progress|tojson }};
    </script>
    <script src="{{ url_for('static', filename='js/scripts.js') }}"></script>
    <!-- Favicons -->
    <link
      rel="icon"
      href="{{ url_for('static', filename='favicon.ico') }}"
      type="image/x-icon"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="192x192"
      href="{{ url_for('static', filename='android-icon-192x192.png') }}"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="{{ url_for('static', filename='favicon-32x32.png') }}"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="96x96"
      href="{{ url_for('static', filename='favicon-96x96.png') }}"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="{{ url_for('static', filename='favicon-16x16.png') }}"
    />
    <link
      rel="manifest"
      href="{{ url_for('static', filename='manifest.json') }}"
    />
    <meta name="msapplication-TileColor" content="#ffffff" />
    <meta
      name="msapplication-TileImage"
      content="{{ url_for('static', filename='ms-icon-144x144.png') }}"
    />
    <meta name="theme-color" content="#ffffff" />
  </head>
  <body data-category="{{ current_category }}" data-last-update="{{ last_full_update }}">
    {% from "macros/chapter_table.html" import render_chapter_table %}
    <div class="container">
      <h1>New Chapter Tracker</h1>

        <div class="table-header" id="newChaptersHeader">
          <h2 class="toggle" data-section="new" onclick="toggleSection(this)">
          New Chapters <span class="badge" id="newChaptersBadge">{{ differences|length }}</span>
        </h2>
        <div class="full-update-tooltip">
          <button onclick="forceUpdate()">
            <i class="fas fa-sync-alt"></i> Force Full Update
          </button>
          <span class="tooltiptext" id="lastUpdateTooltip">
            {{ last_full_update }}
          </span>
        </div>
      </div>

      <div class="collapsible-content" id="newChaptersContent">
        {% if differences %}
        {{ render_chapter_table(
          differences,
          show_found_column=True,
          show_save_button=True
        ) }}
        {% else %}
        <div class="status-box status-success">
          <i class="fas fa-check-circle"></i>
          <span>All chapters are up to date!</span>
        </div>
        {% endif %}
      </div>

        <div class="table-header" id="sameChaptersHeader">
        <h2 class="toggle" data-section="same" onclick="toggleSection(this)">
          No New Chapters <span class="badge" id="sameChaptersBadge">{{ same_data|length }}</span>
        </h2>
      </div>

      <div class="collapsible-content collapsed" id="sameChaptersContent">
        {% if same_data %}
        {{ render_chapter_table(
          same_data,
        ) }}
        {% else %}
        <div class="status-box status-info">
          <i class="fas fa-info-circle"></i>
          <span>No entries being tracked yet.</span>
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Floating Add Button & Add Modal -->
    <button id="floatingAddBtn" class="floating-add" aria-label="Add link">
      <i class="fas fa-plus"></i>
    </button>

    <div
      id="addModal"
      class="modal hidden"
      role="dialog"
      aria-modal="true"
      aria-labelledby="addModalTitle"
    >
      <div class="modal-backdrop" id="addModalBackdrop" tabindex="-1"></div>
      <div class="modal-box" role="document">
        <h2 id="addModalTitle">Add New Link</h2>
        <div class="modal-body">
          <input id="modalName" type="text" placeholder="Name" />
          <input id="modalUrl" type="text" placeholder="URL" />
          <label class="modal-field">
            <input
              id="modalFrequency"
              type="number"
              min="1"
              step="1"
              placeholder="Update frequency (days)"
            />
          <span class="modal-info tooltip" aria-hidden="true">
            <i class="fas fa-info-circle"></i>
            <span class="tooltiptext info-tooltiptext">
              Using a longer update frequency reduces scrape pressure on the
              source and can help avoid rate limits; shorter intervals keep you
              closer to new chapters. Manual updates always fetch whateverâ€™s
              available, no matter the schedule.
            </span>
          </span>
          </label>
        </div>
        <label class="modal-checkbox">
          <input type="checkbox" id="modalFreeOnly" />
          <span class="custom-checkbox" aria-hidden="true"></span>
          <span>Restrict to free chapters only</span>
        </label>
        <div class="modal-actions">
          <button id="modalAddBtn"><i class="fas fa-plus"></i> Add</button>
          <button id="modalCancelBtn" class="danger">Cancel</button>
        </div>
      </div>
    </div>

    <div id="overlay" class="hidden" role="alert" aria-live="assertive">
      <div id="overlay-content">
        <div id="spinner"></div>
        <div id="statusMessage">Loading...</div>
        <div id="progressBar">
          <div id="progressFill"></div>
        </div>
      </div>
    </div>

    <div id="historyModalBackdrop" class="modal-backdrop hidden" role="dialog" aria-modal="true">
      <div class="history-modal">
        <div class="history-modal__header">
          <h3 id="historyModalTitle">Link History</h3>
          <p class="history-modal__meta">
            <span>Added: <strong id="historyAddedAt">Unknown</strong></span>
            <span>Last attempt: <strong id="historyLastAttempt">Unknown</strong></span>
          </p>
          <div class="history-pill-group">
            <span class="pill" id="historyFrequencyPill"></span>
            <span class="pill" id="historyFreeOnlyPill"></span>
          </div>
        </div>
        <div class="history-list" id="historyList"></div>
      </div>
    </div>

  </body>
</html>
